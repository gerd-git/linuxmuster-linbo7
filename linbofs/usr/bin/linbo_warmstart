#!/bin/sh
#
# linbo_warmstart <device>
# thomas@linuxmuster.net
# 20220408
#

if [ -n "$1" ]; then
  CACHE="$1"
else
  CACHE="$(grep -iw ^cache /start.conf | tail -1 | awk -F\= '{print $2}' | awk '{print $1}' | awk -F\# '{print $1}' | awk '{print $1}')"
fi

if [ ! -b "$CACHE" ]; then
  [ -z "$CACHE" ] && CACHE="<None>"
  echo "Cache $CACHE is not a blockdevice!"
  exit 1
fi

KEXEC="/sbin/kexec"
KERNEL="linbo64"
INITRD="linbofs64.lz"
APPEND="$(cat /proc/cmdline)"
[ -d /sys/firmware/efi/efivars ] && EFI="true"

# test for warmstart boot parameter
warmstart="yes"
for i in $APPEND; do case "$i" in warmstart=*) eval $i ;; esac; done

# no warmstart in this cases
if [ "$warmstart" = "no" ]; then
  echo "Skipping linbo warmstart cause it is set to no."
  exit 0
fi
if [ -n "$EFI" ]; then
  echo "UEFI system detected, skipping linbo warmstart."
  exit 0
fi

cd /
linbo_cmd mountcache "$CACHE"

# load linbo kernel
if ! $KEXEC --type="bzImage" --append="$APPEND" --initrd="/cache/$INITRD" --load "/cache/$KERNEL"; then
  echo "Failed to load kernel!"
  exit 1
fi
# execute linbo kernel
if ! $KEXEC -e; then
  echo "Failed to execute kernel!"
  exit 1
fi
